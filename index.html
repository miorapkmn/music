<!DOCTYPE html>
<html lang="en" data-i18n-root="/lang" data-i18n-default="en" data-i18n-languages="en:English,fr:français,es:español,ja:日本語" data-i18n-safemode>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title data-i18n-title="%lang.title|Miora%">Miora Music Library</title>
    <link rel="stylesheet" href="https://cdn.leafia.eu/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.leafia.eu/monet/bsmonet.css">
    <link rel="stylesheet" href="https://cdn.leafia.eu/fonts/fonts.css">
    <link rel="shortcut icon" href="https://cdn.leafia.eu/avatar/round.webp" type="image/webp">
    <script>
        let FF_FOUC_FIX;
    </script>
    <style>
        .list-group-item-action { cursor: pointer; }
        .badge:not(:last-child) { margin-right: 3px; }
        .badge:not(:first-child) { margin-left: 3px; }
        .badge { color: inherit; }
    </style>
</head>
<body>
    <div id="loader" style="position: fixed; inset: 0; z-index: 999; display: flex; align-items: center; justify-content: center;" class="bg-body">
        <img src="https://cdn.leafia.eu/music/loader.svg" alt="..." style="width: 32px;">
    </div>

    <div id="i18n-switcher"></div>

    <main id="app" style="display: none;">
        <div class="container mt-5">
            <h1 data-i18n-content="%lang.title|Miora%"></h1>

            <p id="count"></p>

            <div class="alert alert-secondary"><span data-i18n-content="%lang.disclaimer%"></span>
                <a href="https://miorapkmn.notion.site/1c1776ba5caa8046903cc62a61714be1?pvs=105"
                   target="_blank" referrerpolicy="no-referrer" data-i18n-content="%lang.signup%"></a>
            </div>
            <input type="text" class="form-control" style="margin-top: 20px; margin-bottom: 20px;"
                   autofocus data-i18n-placeholder="%lang.filter%" id="search" onkeydown="wasm.search();"
                   onkeyup="wasm.search();" onchange="wasm.search();" autocomplete="off">

            <div class="list-group" id="js-data-list"></div>
            <div class="list-group" id="js-data-results" style="display: none;"></div>

            <footer class="text-muted" style="margin-top: 30px; text-align: center;">
                <p><credits-link></credits-link></p>
                <svg src="https://cdn.leafia.eu/banner.svg"></svg>
            </footer>

            <br><br><br>
        </div>
    </main>

    <div class="modal fade" tabindex="-1" id="player" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <div style="display: grid; grid-template-columns: 1fr max-content; grid-gap: 10px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center;">
                            <div>
                                <h5 class="modal-title"><span id="player-title"></span></h5>
                                <div id="player-author"></div>
                                <div id="player-date"></div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div style="display: grid; grid-template-columns: max-content max-content; grid-gap: 10px;">
                                <div style="display: flex; align-items: center;" class="text-muted">
                                    <div>
                                        <div id="player-quality">AAC (256 kbps)</div>
                                        <div data-i18n-content="%lang.cdm|MME%"></div>
                                    </div>
                                </div>
                                <img id="player-kme" src="https://cdn.leafia.eu/music/kme.webp" alt="Miora Media Encryption" style="width: 48px;">
                            </div>
                        </div>
                    </div>
                    <audio id="player-el" data-kme-enable controls style="width: 100%;" controlslist="nodownload,nofullscreen,noremoteplayback" disableremoteplayback="yes"></audio>
                </div>
                <div class="modal-footer">
                    <button id="player-modal-close" class="btn btn-secondary" data-i18n-content="%lang.close%"></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" tabindex="-1" id="versions" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-body">
                    <h5 class="modal-title" data-i18n-content="%lang.versionTitle%"></h5>
                    <p data-i18n-content="%lang.versionSelect|<span id='versions-title'></span>%"></p>
                    <div id="versions-list" class="list-group"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="wasm.version_hide();" class="btn btn-secondary" data-i18n-content="%lang.close%"></button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.leafia.eu/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.leafia.eu/monet/color.js" type="module"></script>
    <script src="https://cdn.leafia.eu/music/dash.all.min.js" referrerpolicy="no-referrer"></script>
    <script src="/dist/kme.min.js"></script>

    <script type="module">
        import * as wasm from "/dist/engine.js";

        (async () => {
            window.showModal = (modal) => {
                window.modals[modal].show();
            }

            window.hideModal = (modal) => {
                window.modals[modal].hide();
            }

            window.l = (message) => {
                let parts = /%([^|]+)(?:\|(.*)|)+%/gm.exec(message);
                let str;

                try {
                    str = eval(parts[1]) ?? parts[1] + (parts[2] ? "(" + parts[2] + ")" : "");
                } catch (e) {
                    str = parts[1] + (parts[2] ? "(" + parts[2] + ")" : "");
                }

                let values = (parts[2] ?? "").split("|").filter(i => i);
                let index = values.length;
                values.reverse();
                for (let value of values) {
                    str = str.replace(new RegExp("(?<!\\\\)%" + index, "gm"), value);
                    index--;
                }
                return str;
            }

            window.completeLoad = () => {
                document.getElementById("loader").style.display = "none";
            }

            window.navigate = (url) => {
                location.href = url;
            }

            window.changeURL = (url, replace = false) => {
                if (replace) {
                    window.history.replaceState({ "pageTitle": document.title }, "", url);
                } else {
                    window.history.pushState({ "pageTitle": document.title }, "", url);
                }
                window.wasm.process_hash();
            }

            await i18nSetup();

            window.modals = {
                version: new bootstrap.Modal(document.getElementById("versions")),
                player: new bootstrap.Modal(document.getElementById("player"))
            }

            await Promise.all(Array.from(document.querySelectorAll("svg[src]")).map(async (i) => {
                i.outerHTML = await (await fetch(i.getAttribute("src"))).text();
            }));

            window.wasm = wasm;
            wasm.default();
        })();
    </script>
    <script src="https://cdn.leafia.eu/i18n.js"></script>
</body>
</html>
